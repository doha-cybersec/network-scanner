var I=Object.defineProperty,z=(e,t,r)=>t in e?I(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,B=(e,t,r)=>z(e,"symbol"!=typeof t?t+"":t,r);import{b as k,a as A}from"./91125fddb13c171d06c5858ecf5bea69.js";import{l as O}from"./4a65be22bddb73e1999558835fb6bba1.js";import{r as $,u as N}from"./34eaacfb0e840cf04d070f0b6c14639f.js";import{E as _}from"./3b2640d687b5327271e57663b50c251b.js";import"./c1f6401f16daacfb12ff6f86c9d0a5d3.js";import{J as j}from"./247181262fddb482b5c9ae0bba2666ad.js";import{c as U}from"./7afd07c687eb49d39fd77bf78fe5ec25.js";import{bf as W}from"./87a84c2cf7b4fda35bfcac0640ac264b.js";k.GlobalWorkerOptions.workerSrc=A;const T=class e{_pdfDoc=null;pageRendering=!1;pageNumPending=null;_scale=1.5;memoryWarningThreshold=157286400;constructor(){this.startMemoryMonitoring()}static getInstance(){return e.instance||(e.instance=new e),e.instance}get scale(){return this._scale}set scale(e){e>0&&(this._scale=e)}startMemoryMonitoring(){window.performance&&performance.memory&&setInterval((()=>{const e=performance.memory.usedJSHeapSize;e>this.memoryWarningThreshold&&(console.warn("Memory usage warning:",Math.round(e/1024/1024),"MB"),this.triggerMemoryCleanup())}),5e3)}async triggerMemoryCleanup(){try{Array.from(document.getElementsByTagName("canvas")).forEach((e=>{document.body.contains(e)||this.cleanupCanvas(e)})),performance.getEntriesByType("resource").forEach((e=>{e.name.startsWith("blob:")&&!document.querySelector(`[src="${e.name}"]`)&&URL.revokeObjectURL(e.name)})),Array.from(document.getElementsByTagName("img")).forEach((e=>{!document.body.contains(e)&&(e.src.startsWith("blob:")||e.src.startsWith("data:"))&&URL.revokeObjectURL(e.src)})),window.gc&&window.gc()}catch(e){console.error("Error during memory cleanup:",e)}}async trackMemoryUsage(e){var t,r;const n=null==(t=performance.memory)?void 0:t.usedJSHeapSize;try{return await e()}finally{const e=null==(r=performance.memory)?void 0:r.usedJSHeapSize;if(n&&e){const t=e-n;t>10485760&&console.warn(`Memory usage increased by ${Math.round(t/1024/1024)}MB`)}}}async convertDocxToPdf(e){const t=document.createElement("div");try{const n={arrayBuffer:await e.arrayBuffer(),styleMap:["p[style-name='Title'] => h1:fresh","p[style-name='Heading 1'] => h1:fresh","p[style-name='Heading 2'] => h2:fresh","p[style-name='Heading 3'] => h3:fresh","p[style-name='heading 1'] => h1:fresh","p[style-name='heading 2'] => h2:fresh","p[style-name='heading 3'] => h3:fresh","p[style-name='List Paragraph'] => li:fresh","p[style-name='List Bullet'] => li:fresh","p[style-name='List Number'] => li:fresh","p[style-name='listparagraph'] => li:fresh","p[style-name='bullet'] => li:fresh","p[style-name='numbered'] => li:fresh","table => table.docx-table","tr => tr.docx-tr","td => td.docx-td","th => th.docx-th","u => u","strike => s","b => strong","i => em","r[style-name='Strong'] => strong","r[style-name='Emphasis'] => em","p[style-name='Quote'] => blockquote:fresh","p[style-name='Intense Quote'] => blockquote.intense:fresh","p[style-name='Subtitle'] => h2:fresh","p[style-name='Caption'] => figcaption:fresh","r[style-name='Hyperlink'] => a","p[style-name='Code'] => pre:fresh > code:fresh","p[style-name='No Spacing'] => p.no-spacing:fresh","pic:pic => img:fresh","w:drawing => img:fresh","p[style-name='List Bullet 2'] => li.bullet-2:fresh","p[style-name='List Bullet 3'] => li.bullet-3:fresh","p[style-name='List Number 2'] => li.number-2:fresh","p[style-name='List Number 3'] => li.number-3:fresh","p[style-name='Table Header'] => th:fresh","p[style-name='Table Content'] => td:fresh","p[style-name='Footer'] => footer:fresh","p[style-name='Header'] => header:fresh","r[style-name='Subscript'] => sub","r[style-name='Superscript'] => sup","p[style-name='Note'] => div.note:fresh","r[style-name='Highlight'] => mark"],transformDocument:e=>{if("table"===e.type&&(e.styleId="docx-table",e.children.forEach((e=>{"tableRow"===e.type&&(e.styleId="docx-tr",e.children.forEach((e=>{"tableCell"===e.type&&(e.styleId="docx-td")})))}))),"paragraph"===e.type&&e.numbering){const t=e.numbering.level||0,r=e.numbering.isOrdered;e.type="list-item",e.listLevel=t,e.isOrdered=r,t>0&&(e.styleId=`list-level-${t}`),void 0!==e.numbering.start&&(e.listStart=e.numbering.start)}return"image"===e.type&&(e.styleId="docx-image",e.altText&&(e.alt=e.altText),e.title&&(e.title=e.title)),e}},o=await O.convertToHtml(n),a=new _({unit:"pt",format:"a4",orientation:"portrait"}),l=`${U.extension_dir}assets/fonts/NotoSans-Regular.ttf`,s=`${U.extension_dir}assets/fonts/NotoSans-Bold.ttf`,i=async e=>{const t=await(await fetch(e)).arrayBuffer();return c(t)},c=e=>{let t="";const r=new Uint8Array(e),n=r.byteLength;for(let o=0;o<n;o++)t+=String.fromCharCode(r[o]);return window.btoa(t)};try{const e=await i(l),t=await i(s);a.addFileToVFS("NotoSans-Regular-normal.ttf",e),a.addFileToVFS("NotoSans-Bold-normal.ttf",t),a.addFont("NotoSans-Regular-normal.ttf","NotoSans","normal"),a.addFont("NotoSans-Bold-normal.ttf","NotoSans","bold"),a.setFont("NotoSans")}catch(r){console.error("Error loading fonts:",r),a.setFont("times","normal")}t.innerHTML=o.value,t.style.width="595px",t.style.position="absolute",t.style.left="-9999px",t.style.fontFamily="Arial",t.style.fontSize="12px",document.body.appendChild(t);let d=40;const h=40,f=undefined,m=842,p=595-2*h;let g=0,u=1;const y=async e=>{const t="OL"===e.tagName,r=e.getElementsByTagName("li");for(let n=0;n<r.length;n++){const e=r[n].textContent||"",o=20*g;let l=t?`${u}. `:"â€¢ ";t&&u++;const s=p-o-20,i=a.splitTextToSize(e,s);d+15*i.length>m-h&&(a.addPage(),d=h),a.setFontSize(12),a.setFont("NotoSans","normal"),a.text(l,h+o,d),a.text(i,h+o+20,d),d+=15*i.length+5}d+=10},w=async e=>new Promise((t=>{const r=()=>{try{const r=e.src;if(!r.startsWith("data:"))return console.error("Invalid image data"),void t();const n=e.naturalWidth/e.naturalHeight,o=p,l=Math.min(e.naturalWidth,o)/n;d+l>m-h&&(a.addPage(),d=h);const s=r.match(/^data:image\/(\w+);base64,/);if(!s)return console.error("Invalid image format"),void t();const i=s[1].toUpperCase();d+=l+20,t()}catch(r){console.error("Error adding image to PDF:",r),t()}};e.complete?r():(e.onload=r,e.onerror=()=>{console.error("Error loading image"),t()})})),b=async e=>{const t=Array.from(e.rows).map((e=>Array.from(e.cells).map((e=>{var t;return(null==(t=e.textContent)?void 0:t.trim())||""})))),r=Math.max(...t.map((e=>e.length))),n=p/r,o={};for(let a=0;a<r;a++)o[a]={cellWidth:n};await a.autoTable({head:[t[0]],body:t.slice(1),startY:d,margin:{left:h,right:h},columnStyles:o,styles:{fontSize:10,cellPadding:5,overflow:"linebreak",halign:"left",font:"NotoSans"},headStyles:{fillColor:[240,240,240],textColor:[0,0,0],fontStyle:"bold",font:"NotoSans"}}),d=a.lastAutoTable.finalY+10};for(const e of Array.from(t.children)){if(e instanceof HTMLUListElement||e instanceof HTMLOListElement){await y(e);continue}if(e instanceof HTMLTableElement){await b(e);continue}const t=e.textContent||"",r=e.tagName.toLowerCase();"h1"===r?(a.setFontSize(24),a.setFont("NotoSans","bold")):"h2"===r?(a.setFontSize(20),a.setFont("NotoSans","bold")):"h3"===r?(a.setFontSize(16),a.setFont("NotoSans","bold")):(a.setFontSize(12),a.setFont("NotoSans","normal"));const n=a.splitTextToSize(t,p);d+12*n.length>m-h&&(a.addPage(),d=h),a.text(n,h,d),d+=n.length*(r.startsWith("h")?30:20)}return t.parentNode&&document.body.removeChild(t),new Uint8Array(a.output("arraybuffer"))}catch(n){throw console.error("Error converting DOCX to PDF:",n),new Error("Failed to convert DOCX to PDF")}}async convertExcelToPdf(e){try{const t=await e.arrayBuffer(),r=$(t,{type:"array"}),n=new _({unit:"pt",format:"a4",orientation:"landscape"});for(let e=0;e<r.SheetNames.length;e++){const t=r.SheetNames[e],o=r.Sheets[t],a=N.decode_range(o["!ref"]||"A1"),l=[],s=[];for(let e=a.s.c;e<=a.e.c;e++){let t=0;for(let r=a.s.r;r<=a.e.r;r++){const n=undefined,a=o[N.encode_cell({r:r,c:e})];if(a){const e=a.w||(void 0!==a.v?a.v.toString():"");t=Math.max(t,e.length)}}s[e]=Math.min(Math.max(7*t,50),200)}for(let e=a.s.r;e<=a.e.r;e++){const t=[];for(let r=a.s.c;r<=a.e.c;r++){const n=undefined,a=o[N.encode_cell({r:e,c:r})],l=(null==a?void 0:a.s)||{};let s="",i={fontStyle:"normal",halign:"left",fillColor:void 0,textColor:[0,0,0],fontSize:10};if(a){switch(a.t){case"n":s=typeof a.w<"u"?a.w:a.v.toString(),i.halign="right";break;case"b":s=a.v?"TRUE":"FALSE",i.halign="center";break;case"d":s=a.w||new Date(a.v).toLocaleDateString(),i.halign="right";break;case"s":case"str":s=a.v;break;default:s=a.w||""}l.fgColor&&(i.fillColor=[240,240,240]),l.bold&&(i.fontStyle="bold"),l.italic&&(i.fontStyle="italic")}t.push({content:s,styles:i})}l.push(t)}e>0&&n.addPage(),n.setFont("helvetica","bold"),n.setFontSize(16),n.text(t,40,40);const i=n.internal.pageSize.width,c=s.reduce(((e,t)=>e+t),0),d=Math.max(40,(i-c)/2),h={};s.forEach(((e,t)=>{h[t]={cellWidth:e}})),l.length>0&&await n.autoTable({head:[l[0]],body:l.slice(1),startY:60,margin:{left:d,right:d},columnStyles:h,styles:{fontSize:10,cellPadding:6,overflow:"linebreak",font:"helvetica",lineWidth:.5,lineColor:[80,80,80]},headStyles:{fillColor:[240,240,240],textColor:[0,0,0],fontStyle:"bold",fontSize:11,cellPadding:8,halign:"center",valign:"middle",lineWidth:1,lineColor:[60,60,60]},alternateRowStyles:{fillColor:[248,248,248]},didParseCell:function(e){const t=e.row.raw[e.column];t&&t.styles&&(Object.assign(e.cell.styles,t.styles),0===e.row.index&&(e.cell.styles.fontStyle="bold",e.cell.styles.fontSize=11,e.cell.styles.cellPadding=8))},willDrawCell:function(e){if(0===e.row.index){const t=e.doc,r=e.cell.styles.fillColor;if(r){const n=e.cell.x,o=e.cell.y,a=e.cell.width,l=e.cell.height;t.setFillColor(r[0],r[1],r[2]),t.rect(n,o,a,l,"F")}}}})}return new Uint8Array(n.output("arraybuffer"))}catch(t){throw console.error("Error converting Excel to PDF:",t),new Error("Failed to convert Excel to PDF")}}async convertPptToPdf(e){try{let t=function(e){const t=e.match(/<p:bg[^>]*>[\s\S]*?<a:solidFill>[\s\S]*?<a:srgbClr[^>]*val="([0-9A-Fa-f]{6})"/);if(!t)return null;const r=t[1],n=undefined,o=undefined,a=undefined;return{r:parseInt(r.substring(0,2),16),g:parseInt(r.substring(2,4),16),b:parseInt(r.substring(4,6),16)}},r=function(e){return[...e.matchAll(/<a:t[^>]*>([\s\S]*?)<\/a:t>/g)].map((e=>e[1].trim())).filter(Boolean)};const n=await e.arrayBuffer(),o=await j.loadAsync(n),a=Object.keys(o.files).filter((e=>/^ppt\/slides\/slide\d+\.xml$/.test(e)));a.sort(((e,t)=>{var r,n;const o=undefined,a=undefined;return parseInt((null==(r=e.match(/slide(\d+)\.xml$/))?void 0:r[1])||"0",10)-parseInt((null==(n=t.match(/slide(\d+)\.xml$/))?void 0:n[1])||"0",10)}));const l=new _({unit:"pt",format:"letter",orientation:"landscape"});let s=!0;for(const e of a){const n=await o.files[e].async("string"),a=t(n),i=r(n);s||l.addPage(),s=!1;const c=l.internal.pageSize.getWidth(),d=l.internal.pageSize.getHeight();a?(l.setFillColor(a.r,a.g,a.b),l.rect(0,0,c,d,"F")):(l.setFillColor(255,255,255),l.rect(0,0,c,d,"F")),l.setFont("helvetica","normal"),l.setFontSize(12);let h=60;const f=16,m=50,p=c-2*m;for(const e of i){const t=l.splitTextToSize(e,p);h+t.length*f>d-50&&(l.addPage(),a?(l.setFillColor(a.r,a.g,a.b),l.rect(0,0,c,d,"F")):(l.setFillColor(255,255,255),l.rect(0,0,c,d,"F")),h=60),l.text(t,m,h),h+=t.length*f+f}}return new Uint8Array(l.output("arraybuffer"))}catch(t){throw console.error("Error converting PPT/PPTX to PDF:",t),new Error("Failed to convert PPT/PPTX to PDF")}}async loadPDF(e){try{let t;if(console.log("Loading PDF"),e.type.includes("pdf")){const r=await e.arrayBuffer();t=new Uint8Array(r)}else if(e.type.includes("wordprocessingml.document")||e.type.includes("msword"))t=await this.convertDocxToPdf(e);else if(e.type.includes("spreadsheetml.sheet")||e.type.includes("ms-excel"))t=await this.convertExcelToPdf(e);else{if(!e.type.includes("presentationml")&&!e.type.includes("ms-powerpoint"))throw new Error("Unsupported file type");t=await this.convertPptToPdf(e)}const r=k.getDocument({data:t});this._pdfDoc=W(await r.promise)}catch(t){throw await this.cleanup(),t}}get numPages(){const e=this.getPdfDoc();return e?e.numPages:0}getPdfDoc(){return this._pdfDoc?W(this._pdfDoc):null}async renderPage(e,t=this.scale,r=!1){return this.trackMemoryUsage((async()=>{const n=this.getPdfDoc();if(!n)throw new Error("Document not loaded");if(e<=0||e>n.numPages)throw new Error("Invalid page number");let o=null,a=null,l=null;try{o=await n.getPage(e);const s=r?1:window.devicePixelRatio||1,i=o.getViewport({scale:1});let c;if(r){const e=undefined,t=96*s,r=72*s/i.width,n=t/i.height;c=Math.min(r,n)}else c=t*s;const d=o.getViewport({scale:c}),h=document.createElement("div");h.className=r?"pdf-thumbnail-container":"pdf-page-container",r&&(h.style.width="72px",h.style.height="96px"),a=document.createElement("canvas");const f=a.getContext("2d",{alpha:!1,willReadFrequently:!1,desynchronized:!0});if(!f)throw new Error("Unable to get canvas context");if(a.width=Math.ceil(d.width),a.height=Math.ceil(d.height),r){const e=d.width/d.height,t=undefined;if(e>.75){a.style.width="72px";const t=Math.round(72/e);a.style.height=`${t}px`,a.style.marginTop=`${Math.max(0,(96-t)/2)}px`}else{a.style.height="96px";const t=Math.round(96*e);a.style.width=`${t}px`,a.style.marginLeft=`${Math.max(0,(72-t)/2)}px`}}else a.style.width=d.width/s+"px",a.style.height=d.height/s+"px";let m;if(f.imageSmoothingEnabled=!0,f.imageSmoothingQuality="high",f.fillStyle="white",f.fillRect(0,0,a.width,a.height),h.appendChild(a),r){await o.render({canvasContext:f,viewport:d,intent:"display"}).promise;const e=a.toDataURL("image/jpeg",.8),t=document.createElement("img");t.src=e,t.style.width="100%",t.style.height="100%",t.style.objectFit="contain",h.innerHTML="",h.appendChild(t),m={container:h,width:72,height:96}}else{l=document.createElement("div"),l.className="pdf-text-layer",l.style.setProperty("--scale-factor",t.toString()),h.appendChild(l);const e=await o.getTextContent(),r=k.renderTextLayer({textContentSource:e,container:l,viewport:o.getViewport({scale:t}),textDivs:[]}),n=o.render({canvasContext:f,viewport:d,intent:"display"});await Promise.all([n.promise,r.promise]),m={container:h,width:d.width/s,height:d.height/s}}return m}catch(s){throw console.error("Error in renderPage:",s),s}finally{if(o)try{await o.cleanup()}catch(s){console.error("Error during page cleanup:",s)}}}))}async cleanup(){try{if(this._pdfDoc){try{const e=this._pdfDoc.numPages,t=[];for(let r=1;r<=e;r++)t.push((async()=>{try{const e=await this._pdfDoc.getPage(r);if(e){const t=await e.getTextContent();t&&(t.items&&(t.items.length=0),Object.keys(t).forEach((e=>{t[e]=null}))),e._transport&&await e._transport.cleanup(),e._intentStates&&e._intentStates.clear(),await e.cleanup()}}catch(e){console.error(`Error cleaning up page ${r}:`,e)}})());await Promise.all(t)}catch(e){console.error("Error cleaning up pages:",e)}try{this._pdfDoc._transport&&(await this._pdfDoc._transport.destroy(),this._pdfDoc._transport=null),this._pdfDoc._worker&&(await this._pdfDoc._worker.destroy(),this._pdfDoc._worker=null),await this._pdfDoc.destroy()}catch(e){console.error("Error destroying PDF document:",e)}this._pdfDoc=null}if(this.pageRendering=!1,this.pageNumPending=null,this._scale=1.5,k.GlobalWorkerOptions)try{const e=k.GlobalWorkerOptions.workerSrc;e&&"string"==typeof e&&URL.revokeObjectURL(e)}catch(e){console.error("Error cleaning up worker:",e)}try{Array.from(document.querySelectorAll('img[src^="blob:"], img[src^="data:"]')).forEach((e=>{e.src&&URL.revokeObjectURL(e.src)})),Array.from(document.getElementsByTagName("canvas")).forEach((e=>this.cleanupCanvas(e))),window.performance&&window.performance.memory&&performance.getEntriesByType("resource").forEach((e=>{e.name.startsWith("blob:")&&URL.revokeObjectURL(e.name)}))}catch(e){console.error("Error cleaning up resources:",e)}if(window.gc)try{window.gc()}catch(e){console.error("Error forcing garbage collection:",e)}}catch(e){console.error("Error during cleanup:",e),this._pdfDoc=null,this.pageRendering=!1,this.pageNumPending=null}}cleanupCanvas(e){if(e)try{const t=e.getContext("2d");if(t){t.clearRect(0,0,e.width,e.height);const r=e.toDataURL();r&&URL.revokeObjectURL(r),t.canvas=null}e.width=1,e.height=1,e.oncontextmenu=null,e.onmousemove=null,e.onclick=null,e.onmousedown=null,e.onmouseup=null}catch(t){console.error("Error cleaning up canvas:",t)}}};B(T,"instance",null);let H=T;export{H as F};